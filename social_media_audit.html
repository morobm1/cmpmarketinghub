<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Social Media Audit â€¢ Marketing Hub</title>
  <link rel="preconnect" href="https://use.typekit.net" crossorigin>
  <link rel="preconnect" href="https://p.typekit.net" crossorigin>
  <link rel="stylesheet" href="https://use.typekit.net/hqv8hwr.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <meta name="description" content="View recent social posts by platform per property; track images and dates." />
  <style>
    :root{ --brand-primary:#446472; --brand-accent:#ffb732; --brand-accent-2:#52d5ff; --brand-gray:#929497; --page-bg:#e5e7eb; --bg:#ffffff; --panel:#ffffff; --muted:#ffffff; --text:#1f2937; --subtext:#6b7280; --accent:var(--brand-accent-2); --accent-2:var(--brand-accent); --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:'Open Sans', Arial, sans-serif; background:var(--page-bg); color:var(--text)}
    header{padding:16px 18px; border-bottom:1px solid var(--border); position:sticky; top:0; background:#ffffff; z-index:20; display:flex; align-items:center; gap:14px; flex-wrap:wrap; box-shadow:0 2px 6px rgba(0,0,0,0.04)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo-img{height:32px;width:auto;display:block}
    .brand .title{color:#ffb732; font-family: zooja-pro, Arial, sans-serif; font-size: clamp(36px, 5vw, 64px); line-height: 1.05}
    .pill{border:1px solid var(--border); background:#ffffff; border-radius:999px; padding:6px 10px; font-size:12px; color:#374151; display:flex; align-items:center; gap:8px}
    .pill select, .pill button{ font-family: Roboto, Arial, sans-serif; }
    .pill select{ background:#ffffff; border:1px solid #d1d5db; border-radius:8px; padding:6px 8px }
    .pill button{ background:#ffffff; color:#111827; border:1px solid #d1d5db; padding:6px 10px; border-radius:8px; cursor:pointer }
    .pill button:hover{ background:#f9fafb }

    .nav-bar{ background:#ffffff; border-bottom:1px solid var(--border); box-shadow:0 1px 3px rgba(0,0,0,0.06) }
    .nav-bar .nav-wrap{ max-width:1200px; margin:0 auto; padding:8px 16px; display:flex; gap:8px; flex-wrap:wrap }
    .nav-tab{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid var(--border); border-radius:999px; color:#374151; text-decoration:none; background:#ffffff; transition: all .15s ease; font-family: Roboto, Arial, sans-serif }
    .nav-tab:hover{ background:#f3f4f6 }
    .nav-tab.active{ background:#52d5ff; border-color:#52d5ff; color:#0b1b24; font-weight:700 }

    .container{padding:18px; max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:16px}
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:#ffffff; color:#111827; font-weight:700; cursor:pointer; font-family: Roboto, Arial, sans-serif }
    .btn:hover{ background:#f9fafb }
    .btn.primary{ background:#52d5ff; border-color:#52d5ff; color:#0b1b24 }
    .btn.warn{ background:#ffb732; border-color:#ffb732; color:#1f1300 }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); cursor:pointer; background:#ffffff; color:#374151; font-weight:700; font-family: Roboto, Arial, sans-serif }
    .tab.active{ background:#446472; color:#ffffff; border-color:#446472 }

    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px }
    .card-sm{ border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#ffffff; box-shadow:0 1px 2px rgba(0,0,0,0.05) }
    .card-sm img{ width:100%; height:180px; object-fit:cover; display:block }
    .meta{ padding:8px 10px; font-size:12px; color:#374151; display:flex; align-items:center; justify-content:space-between }
    .meta a{ color:#446472; text-decoration:none; font-weight:700 }

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#ffffff;border:1px solid var(--border);border-radius:12px;max-width:640px;width:96%;padding:14px}
    .modal h3{margin:0 0 10px 0;color:#374151;font-size:16px}
    .row{display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .row > *{ flex:1 }
    label{display:block; font-size:12px; color:#374151; margin-bottom:6px}
    input, select, textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d1d5db; background:#ffffff; color:#111827; font-size:14px}
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="logo-main.svg" class="logo-img" alt="Capstone" /><div class="title">Marketing Hub</div></div>
    <div class="pill">
      <label for="propertySelect" style="font-size:12px;color:#6b7280">Property</label>
      <select id="propertySelect" style="min-width:220px"></select>
      <button id="logoutBtn">Logout</button>
      <button id="adminPageBtn" style="display:none">Admin</button>
    </div>
    <div class="muted" style="font-size:13px">Capstone Management Partners</div>
  </header>
  <nav id="mainNav" class="nav-bar">
    <div class="nav-wrap">
      <a href="mmp_calendar_app.html" class="nav-tab" data-tab="calendar">Marketing Calendar</a>
      <a href="marketing_contacts.html" class="nav-tab" data-tab="contacts">Marketing Contacts</a>
      <a href="promo_order_tracker.html" class="nav-tab" data-tab="promo">Promo Order Tracker</a>
      <a href="velocity_tracker.html" class="nav-tab" data-tab="velocity">Velocity Tracker</a>
      <a href="social_media_audit.html" class="nav-tab" data-tab="social">Social Media Audit</a>
    </div>
  </nav>

  <main class="container">
    <div class="toolbar">
      <div class="tabs">
        <button class="tab active" data-platform="instagram">Instagram</button>
        <button class="tab" data-platform="facebook">Facebook</button>
        <button class="tab" data-platform="tiktok">TikTok</button>
      </div>
      <div style="flex:1"></div>
      <button id="addPostBtn" class="btn">+ Add Post (manual)</button>
    </div>

    <section class="card">
      <h3>Recent Posts</h3>
      <div class="content">
        <div id="postsGrid" class="grid"></div>
      </div>
    </section>
  </main>

  <div id="postModal" class="modal-backdrop">
    <div class="modal">
      <h3>Add Post (manual)</h3>
      <div class="row">
        <div>
          <label for="p_platform">Platform</label>
          <select id="p_platform"><option>instagram</option><option>facebook</option><option>tiktok</option></select>
        </div>
        <div>
          <label for="p_date">Date</label>
          <input id="p_date" type="date" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="p_image">Image URL</label>
          <input id="p_image" type="url" placeholder="https://..." />
        </div>
        <div>
          <label for="p_link">Post Link (optional)</label>
          <input id="p_link" type="url" placeholder="https://..." />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="p_caption">Caption (optional)</label>
          <input id="p_caption" type="text" />
        </div>
      </div>
      <div class="actions">
        <button id="p_cancel" class="btn">Cancel</button>
        <button id="p_save" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <script>
    const STORE_CURRENT_PROPERTY_KEY = 'mmp_current_property_v1';
    const API_BASE = '/api';

    const els = {
      propertySelect: document.getElementById('propertySelect'),
      logoutBtn: document.getElementById('logoutBtn'),
      adminPageBtn: document.getElementById('adminPageBtn'),
      postsGrid: document.getElementById('postsGrid'),
      addPostBtn: document.getElementById('addPostBtn'),
      postModal: document.getElementById('postModal'),
      p_platform: document.getElementById('p_platform'),
      p_date: document.getElementById('p_date'),
      p_image: document.getElementById('p_image'),
      p_link: document.getElementById('p_link'),
      p_caption: document.getElementById('p_caption'),
    };

    let currentProperty = '';
    let currentPlatform = 'instagram';

    async function apiJson(path, opts = {}){
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers||{});
      const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      if (!res.ok){ const t = await res.text(); throw new Error(t || ('HTTP '+res.status)); }
      return res;
    }

    function setActivePlatform(p){ currentPlatform = p; document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('data-platform')===p)); loadPosts(); }

    async function loadPosts(){
      if (!currentProperty) return;
      try{
        const res = await apiJson(`/social-feed?property=${encodeURIComponent(currentProperty)}&platform=${encodeURIComponent(currentPlatform)}&limit=60`);
        const items = await res.json();
        renderPosts(items);
      }catch(e){ els.postsGrid.innerHTML = '<div class="mini" style="color:#6b7280">No posts found.</div>'; }
    }

    function renderPosts(items){
      if (!Array.isArray(items) || !items.length){ els.postsGrid.innerHTML = '<div class="mini" style="color:#6b7280">No posts found.</div>'; return; }
      els.postsGrid.innerHTML = items.map(it => {
        const dt = it.timestamp ? new Date(it.timestamp).toLocaleDateString() : '';
        const a = it.permalink ? `<a href="${it.permalink}" target="_blank" rel="noopener">Open</a>` : '';
        return `<div class="card-sm">
          <img src="${it.imageUrl}" alt="post" />
          <div class="meta"><span>${dt}</span><span>${a}</span></div>
        </div>`;
      }).join('');
    }

    // Manual add post
    function openPostModal(){ els.postModal.style.display = 'flex'; els.p_platform.value = currentPlatform; els.p_date.valueAsDate = new Date(); els.p_image.value=''; els.p_link.value=''; els.p_caption.value=''; }
    function closePostModal(){ els.postModal.style.display = 'none'; }
    els.addPostBtn.onclick = openPostModal;
    document.getElementById('p_cancel').onclick = closePostModal;
    document.getElementById('p_save').onclick = async ()=>{
      const platform = els.p_platform.value; const date = els.p_date.value; const imageUrl = els.p_image.value.trim(); const permalink = els.p_link.value.trim(); const caption = els.p_caption.value.trim();
      if (!imageUrl || !date){ alert('Image URL and Date are required'); return; }
      try{
        await apiJson('/social-feed', { method:'POST', body: JSON.stringify({ property: currentProperty, platform, imageUrl, timestamp: new Date(date).toISOString(), permalink, caption }) });
        closePostModal();
        loadPosts();
      }catch(e){ alert('Save failed: '+e.message); }
    };

    // Tabs
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=> setActivePlatform(t.getAttribute('data-platform')) ));

    // Nav active
    (function(){ const nav = document.getElementById('mainNav'); if (!nav) return; const path = (location.pathname||'').toLowerCase(); nav.querySelectorAll('.nav-tab').forEach(a=>{ const href=(a.getAttribute('href')||'').toLowerCase(); if (href && (path.endsWith(href) || path.endsWith('/'+href))) a.classList.add('active'); }); })();

    async function api(path, opts={}){ const res = await fetch('/api' + path, opts); if (!res.ok) throw new Error(await res.text() || ('HTTP '+res.status)); return res; }
    function getAccessible(properties, me){ const names = properties.map(p => p.name).filter(Boolean); if (!me) return names; if (me.role === 'admin') return names; if (me.properties === '*') return names; const allowed = Array.isArray(me.properties) ? me.properties : []; return names.filter(n => allowed.includes(n)); }

    async function init(){
      try{
        const meRes = await fetch('/api/me');
        if (!meRes.ok){ location.href = 'index.html'; return; }
        const me = await meRes.json();
        if (els.adminPageBtn){ els.adminPageBtn.style.display = me.role === 'admin' ? '' : 'none'; els.adminPageBtn.onclick = ()=>{ location.href='mmp_admin.html'; } }
        if (els.logoutBtn){ els.logoutBtn.onclick = async ()=>{ try{ await fetch('/api/auth-logout', { method:'POST' }); }catch(e){} location.href='index.html'; }; }

        let props = [];
        try{ const pres = await api('/properties'); props = await pres.json(); }catch(e){ props = []; }
        const list = getAccessible(props, me);
        const saved = (localStorage.getItem(STORE_CURRENT_PROPERTY_KEY)||'').trim();
        const current = list.includes(saved) ? saved : (list[0] || '');
        if (els.propertySelect){
          els.propertySelect.innerHTML = list.map(p => `<option value="${p.replace(/"/g,'&quot;')}">${p}</option>`).join('');
          els.propertySelect.value = current;
          els.propertySelect.onchange = ()=>{ currentProperty = els.propertySelect.value; loadPosts(); };
        }
        currentProperty = current;
        setActivePlatform('instagram');
      }catch(e){ location.href = 'index.html'; }
    }

    init();
  </script>
</body>
</html>
