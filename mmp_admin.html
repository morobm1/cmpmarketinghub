<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - User Management</title>
  <meta name="description" content="Manage users, roles, and property access">
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --border:#374151; --accent:#22d3ee; --good:#34d399; --warn:#f59e0b; --bad:#f87171;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background:linear-gradient(160deg, var(--bg), #020617 60%); color:var(--text)}
    header{padding:16px 18px; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(15,23,42,0.9); backdrop-filter: blur(6px); z-index:10; display:flex; align-items:center; gap:14px; flex-wrap:wrap}
    header .title{font-weight:800}
    .pill{border:1px solid var(--border); background:var(--panel); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--sub)}

    .container{padding:18px; max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:16px}

    .card{background:linear-gradient(180deg, rgba(17,24,39,0.92), rgba(2,6,23,0.85)); border:1px solid var(--border); border-radius:14px; overflow:hidden}
    .card h3{margin:0; padding:12px 14px 0 14px; font-size:14px; color:var(--sub); font-weight:700}
    .card .content{padding:12px 14px 14px 14px}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1}

    label{font-size:12px; color:var(--sub); display:block; margin-bottom:6px}
    input, select, textarea, button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--muted); color:var(--text); font-size:14px}
    textarea{min-height:64px; resize:vertical}
    button{cursor:pointer; border-color:transparent; background:linear-gradient(180deg, #0ea5e9, #22d3ee); color:#001018; font-weight:800}
    button.secondary{background:var(--muted); color:var(--text); border:1px solid var(--border); font-weight:700}
    button.warn{background:linear-gradient(180deg,#f59e0b,#fbbf24); color:#1f1300}
    button.danger{background:linear-gradient(180deg,#ef4444,#f87171); color:#1f0a0a}
    .mini{font-size:11px; color:var(--sub)}

    .grid{max-height:60vh; overflow:auto; border:1px solid var(--border); border-radius:10px}

    table{width:100%; border-collapse:separate; border-spacing:0;}
    thead th{background:#0b1021; color:var(--sub); font-weight:700; font-size:12px; text-align:left; padding:10px; border-bottom:1px solid var(--border)}
    tbody td{padding:10px; border-bottom:1px solid var(--border); font-size:13px; vertical-align:top}
    .prop-list{display:flex; flex-direction:column; gap:6px}
    .prop-item{display:flex; align-items:center; justify-content:flex-start; padding:8px 10px; border:1px solid var(--border); border-radius:8px; cursor:pointer; background:var(--muted); color:var(--text); user-select:none}
    .prop-item.selected{border-color: var(--accent); background: rgba(34,211,238,0.12)}

    .hidden{display:none}
  </style>
</head>
<body>
  <header id="appHeader" class="hidden">
    <div class="title">Admin â€¢ User Management</div>
    <div class="pill mini">Only admins can access</div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button id="toCalendarBtn" class="secondary">Back to Calendar</button>
      <button id="logoutBtn" class="secondary">Logout</button>
    </div>
  </header>

  <main id="appContainer" class="container hidden">
    <section class="card">
      <h3>Create User</h3>
      <div class="content">
        <div class="row">
          <div>
            <label for="newUsername">Username</label>
            <input id="newUsername" type="text" />
          </div>
          <div>
            <label for="newPassword">Temp Password</label>
            <input id="newPassword" type="password" />
            <div class="mini" style="margin-top:6px;display:flex;align-items:center;gap:6px">
              <label style="display:flex;align-items:center;gap:6px;user-select:none"><input id="toggleNewPw" type="checkbox" /> Show password</label>
            </div>
          </div>
          <div>
            <label for="newRole">Role</label>
            <select id="newRole"><option value="user">User</option><option value="admin">Admin</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Assign Properties</label>
            <div id="newPropsWrap" class="grid" style="padding:8px; max-height:300px; overflow:auto"></div>
            <div class="mini" style="margin-top:6px; display:flex; gap:8px">
              <button id="selectAllPropsBtn" class="secondary" style="flex:0 0 auto; padding:6px 8px">Select All</button>
              <button id="clearAllPropsBtn" class="secondary" style="flex:0 0 auto; padding:6px 8px">Clear All</button>
            </div>
          </div>
          <div style="align-self:flex-end">
            <button id="createUserBtn" class="good">Create User</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Users</h3>
      <div class="content">
        <div id="usersTable" class="grid"></div>
      </div>
    </section>

    <div class="mini">Changes are saved to the server (MongoDB Atlas) via API.</div>
  </main>

  <script>
    const API_BASE = '/api';

    // Elements
    const els = {
      appHeader: document.getElementById('appHeader'),
      appContainer: document.getElementById('appContainer'),
      toCalendarBtn: document.getElementById('toCalendarBtn'),
      logoutBtn: document.getElementById('logoutBtn'),

      newUsername: document.getElementById('newUsername'),
      newPassword: document.getElementById('newPassword'),
      toggleNewPw: document.getElementById('toggleNewPw'),
      newRole: document.getElementById('newRole'),
      selectAllPropsBtn: document.getElementById('selectAllPropsBtn'),
      clearAllPropsBtn: document.getElementById('clearAllPropsBtn'),
      createUserBtn: document.getElementById('createUserBtn'),

      usersTable: document.getElementById('usersTable'),
    };

    if (els.toggleNewPw){ els.toggleNewPw.addEventListener('change', ()=>{ els.newPassword.type = els.toggleNewPw.checked ? 'text' : 'password'; }); }

    // Data
    let properties = [];
    let usersList = [];

    function show(el){ if (el) el.classList.remove('hidden'); }
    function hide(el){ if (el) el.classList.add('hidden'); }

    async function apiFetch(path, opts={}){
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers||{});
      const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
      if (!res.ok){ const text = await res.text(); throw new Error(text || ('HTTP '+res.status)); }
      return res;
    }

    function renderCreateProps(){
      const wrap = document.getElementById('newPropsWrap');
      if (!wrap) return;
      const html = properties.map(p=>{
        const safe = p.replace(/"/g,'&quot;');
        return `<div class="prop-item" data-prop="${safe}">${p}</div>`;
      }).join('');
      wrap.innerHTML = `<div class="prop-list">${html}</div>`;
      wrap.querySelectorAll('.prop-item').forEach(item=>{ item.addEventListener('click', ()=>{ item.classList.toggle('selected'); }); });
    }

    function renderUsers(){
      if (!usersList.length){ els.usersTable.innerHTML = '<div class="mini" style="padding:10px">No users found.</div>'; return; }
      let html = '<table><thead><tr>'+
        '<th>User</th><th>Role</th><th>Properties</th><th style="width:220px"></th></tr></thead><tbody>';
      for (const u of usersList){
        const roleSel = `<select class="uRole" data-u="${u.username}"><option value="user" ${u.role==='user'?'selected':''}>User</option><option value="admin" ${u.role==='admin'?'selected':''}>Admin</option></select>`;
        const items = properties.map(p=>{
          const safe = p.replace(/\"/g,'&quot;');
          const assigned = (u.properties==='*') || ((u.properties||[]).includes(p));
          const sel = assigned ? 'prop-item selected' : 'prop-item';
          return `<div class="${sel}" data-u="${u.username}" data-prop="${safe}">${p}</div>`;
        }).join('');
        const propSel = `<div class="prop-list" data-u="${u.username}" style="max-height:180px; overflow:auto">${items}</div>`;
        html += `<tr>`+
          `<td>${u.username}</td>`+
          `<td>${roleSel}</td>`+
          `<td>${propSel}</td>`+
          `<td>`+
            `<div style="display:flex; flex-direction:column; gap:6px; align-items:flex-start">`+
              `<button class="uSave secondary" data-u="${u.username}">Save</button>`+
              `<button class="uResetPw secondary" data-u="${u.username}">Reset PW</button>`+
              `<button class="uDelete danger" data-u="${u.username}">Delete</button>`+
            `</div>`+
          `</td>`+
        `</tr>`;
      }
      html += '</tbody></table>';
      els.usersTable.innerHTML = html;

      // Wire actions
      els.usersTable.querySelectorAll('.uSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const username = btn.dataset.u;
          const roleEl = els.usersTable.querySelector(`select.uRole[data-u="${username}"]`);
          const role = roleEl ? roleEl.value : 'user';
          const props = Array.from(els.usersTable.querySelectorAll(`.prop-list[data-u="${username}"] .prop-item.selected`)).map(it=>it.dataset.prop);
          try{
            await apiFetch('/auth-users', { method:'PUT', body: JSON.stringify({ username, updates: { role, properties: props } }) });
            alert('Saved');
          }catch(e){ alert('Save failed: '+e.message); }
        });
      });
      els.usersTable.querySelectorAll('.uResetPw').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const username = btn.dataset.u; const pw = prompt(`Enter new password for ${username}`); if (!pw) return;
          try{ await apiFetch('/auth-users', { method:'PUT', body: JSON.stringify({ username, updates: { password: pw } }) }); alert('Password updated'); }
          catch(e){ alert('Password reset failed: '+e.message); }
        });
      });
      els.usersTable.querySelectorAll('.uDelete').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const username = btn.dataset.u; if (!confirm(`Delete user ${username}?`)) return;
          try{ await apiFetch('/auth-users', { method:'DELETE', body: JSON.stringify({ username }) }); await fetchUsers(); renderUsers(); }
          catch(e){ alert('Delete failed: '+e.message); }
        });
      });

      // Toggle property assignment by clicking
      els.usersTable.addEventListener('click', (e)=>{ const it = e.target.closest('.prop-item'); if (it && els.usersTable.contains(it)) { it.classList.toggle('selected'); } });
    }

    async function fetchProperties(){
      try{
        const res = await apiFetch('/properties');
        const list = await res.json();
        properties = (list||[]).map(x => x.name).filter(Boolean);
        if (!properties.length){ await ensurePropertiesSeed(); }
      }catch(e){ alert('Loading properties failed: '+e.message); properties = []; }
      renderCreateProps();
    }

    async function ensurePropertiesSeed(){
      const seed = [
        'M@College', 'Blattner Hall (75 Arkansas)', 'Century Hall', 'Zuma Apartments', 'Cerca Apartments', 'Prisma Apartments', 'Mountain View Hall', 'Lantana Hall', 'Founders Hall', 'Ferry Street Flats', 'The Continuum for UF Grads', 'River House Graduate Housing', 'Infinity Hall', 'Florida Polytechnic University - Phase II', 'Ivory University House', 'Palomar SLO', 'Chorro SLO', 'Florida Polytechnic University - Phase III', 'The Residential Village at UW Bothell', 'Stateside Apartments', 'Bryan Flats', 'Nexus on Holmes (Univ of Alabama, Huntsville)', 'Comma Barrington', 'Meridian on Main (132 E Main Street)', 'The Village at Mines Park', 'Monte Apartments'
      ];
      try{
        for (const name of seed){ await apiFetch('/properties', { method:'POST', body: JSON.stringify({ name }) }); }
      }catch(e){ /* ignore duplicates */ }
      try{
        const res = await apiFetch('/properties');
        const list = await res.json();
        properties = (list||[]).map(x => x.name).filter(Boolean);
      }catch(e){ properties = []; }
    }

    async function fetchUsers(){
      try{ const res = await apiFetch('/auth-users'); usersList = await res.json(); }
      catch(e){ alert('Loading users failed: '+e.message); usersList = []; }
    }

    function initHandlers(){
      els.selectAllPropsBtn.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelectorAll('#newPropsWrap .prop-item').forEach(it=>it.classList.add('selected')); });
      els.clearAllPropsBtn.addEventListener('click', (e)=>{ e.preventDefault(); document.querySelectorAll('#newPropsWrap .prop-item').forEach(it=>it.classList.remove('selected')); });
      els.createUserBtn.addEventListener('click', async ()=>{
        const username = (els.newUsername.value||'').trim(); const password = els.newPassword.value||''; const role = els.newRole.value;
        if (!username || !password){ alert('Username and password are required'); return; }
        const props = Array.from(document.querySelectorAll('#newPropsWrap .prop-item.selected')).map(it=>it.dataset.prop);
        try{
          await apiFetch('/auth-users', { method:'POST', body: JSON.stringify({ username, password, role, properties: props }) });
          els.newUsername.value=''; els.newPassword.value=''; els.newRole.value='user';
          document.querySelectorAll('#newPropsWrap .prop-item.selected').forEach(it=>it.classList.remove('selected'));
          await fetchUsers(); renderUsers();
        }catch(e){ alert('Create user failed: '+e.message); }
      });

      els.toCalendarBtn.addEventListener('click', ()=>{ location.href = 'mmp_calendar_app.html'; });
      els.logoutBtn.addEventListener('click', async ()=>{ try{ await fetch('/api/auth-logout', { method:'POST' }); }catch(e){} location.href = 'index.html'; });
    }

    async function init(){
      // Enforce server session and admin role
      try{
        const meRes = await fetch('/api/me');
        if (!meRes.ok){ location.href = 'index.html'; return; }
        const me = await meRes.json();
        if (me.role !== 'admin'){ location.href = 'index.html'; return; }
      }catch(e){ location.href = 'index.html'; return; }

      show(els.appHeader); show(els.appContainer);
      await fetchProperties();
      await fetchUsers();
      renderUsers();
      initHandlers();
    }

    init();
  </script>
</body>
</html>
