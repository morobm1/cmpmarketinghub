<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MMP â€¢ Login</title>
  <meta name="description" content="Login to the MMP Calendar">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --border:#374151; --good:#34d399; --bad:#f87171; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background:linear-gradient(160deg, var(--bg), #020617 60%); color:var(--text); display:flex; align-items:center; justify-content:center}
    .card{background:linear-gradient(180deg, rgba(17,24,39,0.94), rgba(2,6,23,0.9)); border:1px solid var(--border); border-radius:14px; padding:16px; width:min(92vw, 420px)}
    h1{margin:0 0 8px 0; font-size:18px; color:var(--sub)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:12px; color:var(--sub); display:block; margin:10px 0 6px 0}
    input, button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--muted); color:var(--text); font-size:14px}
    button{cursor:pointer; border-color:transparent; background:linear-gradient(180deg, #0ea5e9, #22d3ee); color:#001018; font-weight:800; margin-top:12px}
    .mini{font-size:11px; color:var(--sub)}
    .err{color:var(--bad); display:none; margin-top:8px}
    .footer{margin-top:10px; font-size:11px; color:var(--sub)}
    .actions{display:flex; gap:10px; align-items:center; justify-content:space-between}
    a{color:#93c5fd; text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Login</h1>
    <div>
      <label for="username">Username</label>
      <input id="username" type="text" autocomplete="username" />
      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" />
      <button id="loginBtn">Sign In</button>
      <div id="error" class="err">Invalid credentials</div>
      <div class="footer mini">You will be redirected to the calendar after login.</div>
    </div>
    <div class="actions mini" style="margin-top:8px">
      <div>Admin user is seeded on first login.</div>
      <div><a href="mmp_admin.html">Admin</a></div>
    </div>
  </div>
  <script>
    // Keys used by the calendar app
    const STORE_USERS_KEY = 'mmp_users_v1';
    const STORE_CURRENT_USER_KEY = 'mmp_current_user_v1';
    const STORE_LOGIN_TIME_KEY = 'mmp_login_time_v1';

    const els = {
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      loginBtn: document.getElementById('loginBtn'),
      error: document.getElementById('error'),
    };

    let users = {};

    async function sha256Hex(str){
      try{
        if (window.crypto && window.crypto.subtle){
          const data = new TextEncoder().encode(str);
          const hash = await window.crypto.subtle.digest('SHA-256', data);
          return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
      }catch(e){}
      return 'plain:' + str; // fallback for environments without SubtleCrypto
    }

    function loadUsers(){ try{ users = JSON.parse(localStorage.getItem(STORE_USERS_KEY)||'{}'); }catch(e){ users = {}; } }
    function saveUsers(){ try{ localStorage.setItem(STORE_USERS_KEY, JSON.stringify(users)); }catch(e){} }

    async function ensureAdminSeed(){
      loadUsers();
      if (!users['morobm1']){
        const hash = await sha256Hex('Admin0701!');
        users['morobm1'] = { passwordHash: hash, role: 'admin', properties: '*' };
        saveUsers();
      }
    }

    async function attemptLogin(){
      const u = (els.username.value||'').trim();
      const p = els.password.value||'';
      loadUsers(); await ensureAdminSeed();
      if (!users[u]){ els.error.style.display=''; return; }
      const hash = await sha256Hex(p);
      if (hash !== users[u].passwordHash){ els.error.style.display=''; return; }
      els.error.style.display='none';
      try{ localStorage.setItem(STORE_CURRENT_USER_KEY, u); }catch(e){}
      try{ localStorage.setItem(STORE_LOGIN_TIME_KEY, String(Date.now())); }catch(e){}
      // Redirect into the calendar
      window.location.href = 'mmp_calendar_app.html';
    }

    els.loginBtn.addEventListener('click', attemptLogin);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') attemptLogin(); });

    // If already logged in, go straight to app
    (function(){
      const u = (localStorage.getItem(STORE_CURRENT_USER_KEY)||'').trim();
      const t = parseInt(localStorage.getItem(STORE_LOGIN_TIME_KEY)||'0', 10) || 0;
      const TTL = 8*60*60*1000; // 8 hours
      if (u && (Date.now() - t) < TTL){ window.location.href = 'mmp_calendar_app.html'; }
    })();
  </script>
</body>
</html>