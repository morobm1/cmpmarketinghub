<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MMP â€¢ Login</title>
  <meta name="description" content="Login to the MMP Calendar">
  <style>
    :root{ --bg:#0f172a; --panel:#111827; --muted:#1f2937; --text:#e5e7eb; --sub:#9ca3af; --border:#374151; --good:#34d399; --bad:#f87171; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial; background:linear-gradient(160deg, var(--bg), #020617 60%); color:var(--text); display:flex; align-items:center; justify-content:center}
    .card{background:linear-gradient(180deg, rgba(17,24,39,0.94), rgba(2,6,23,0.9)); border:1px solid var(--border); border-radius:14px; padding:16px; width:min(92vw, 420px)}
    h1{margin:0 0 8px 0; font-size:18px; color:var(--sub)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:12px; color:var(--sub); display:block; margin:10px 0 6px 0}
    input, button{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:var(--muted); color:var(--text); font-size:14px}
    button{cursor:pointer; border-color:transparent; background:linear-gradient(180deg, #0ea5e9, #22d3ee); color:#001018; font-weight:800; margin-top:12px}
    .mini{font-size:11px; color:var(--sub)}
    .err{color:var(--bad); display:none; margin-top:8px}
    .footer{margin-top:10px; font-size:11px; color:var(--sub)}
    .actions{display:flex; gap:10px; align-items:center; justify-content:space-between}
    a{color:#93c5fd; text-decoration:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Login</h1>
    <div>
      <label for="username">Username</label>
      <input id="username" type="text" autocomplete="username" />
      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" />
      <div class="row" style="margin-top:6px"><label class="mini" style="display:flex;align-items:center;gap:6px;user-select:none"><input id="togglePw" type="checkbox" /> Show password</label></div>
      <button id="loginBtn">Sign In</button>
      <div id="error" class="err">Invalid credentials</div>
      <div class="footer mini">You will be redirected to the calendar after login.</div>
    </div>
    <div class="actions mini" style="margin-top:8px">
      <div>Admin portal</div>
      <div><a href="mmp_admin.html">Admin</a></div>
    </div>
  </div>
  <script>
    const els = { username: document.getElementById('username'), password: document.getElementById('password'), loginBtn: document.getElementById('loginBtn'), error: document.getElementById('error'), togglePw: document.getElementById('togglePw') };
    if (els.togglePw){ els.togglePw.addEventListener('change', ()=>{ els.password.type = els.togglePw.checked ? 'text' : 'password'; }); }

    // Local fallback auth (same storage scheme as app)
    const STORE_USERS_KEY = 'mmp_users_v1';
    const STORE_CURRENT_USER_KEY = 'mmp_current_user_v1';
    const STORE_LOGIN_TIME_KEY = 'mmp_login_time_v1';
    const SESSION_TTL_MS = 8 * 60 * 60 * 1000; // 8 hours

    let users = {};

    async function sha256Hex(str){
      try{
        if (window.crypto && window.crypto.subtle){
          const data = new TextEncoder().encode(str);
          const hash = await window.crypto.subtle.digest('SHA-256', data);
          return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
      }catch(e){ /* ignore */ }
      return 'plain:' + str;
    }
    function loadUsers(){ try{ users = JSON.parse(localStorage.getItem(STORE_USERS_KEY)||'{}'); }catch(e){ users = {}; } }
    function saveUsers(){ try{ localStorage.setItem(STORE_USERS_KEY, JSON.stringify(users)); }catch(e){} }
    async function ensureAdminSeed(){
      if (!users['morobm1']){
        const hash = await sha256Hex('Admin0701!');
        users['morobm1'] = { passwordHash: hash, role: 'admin', properties: '*' };
        saveUsers();
      }
    }

    async function localLogin(username, password){
      loadUsers();
      const u = users[username];
      if (!u) return false;
      const h = await sha256Hex(password);
      if (h !== u.passwordHash) return false;
      try{ localStorage.setItem(STORE_CURRENT_USER_KEY, username); }catch(e){}
      try{ localStorage.setItem(STORE_LOGIN_TIME_KEY, String(Date.now())); }catch(e){}
      return true;
    }

    async function doLogin(){
      els.error.style.display = 'none';
      const username = (els.username.value||'').trim();
      const password = els.password.value||'';
      if (!username || !password){ els.error.textContent = 'Enter username and password'; els.error.style.display=''; return; }
      // Try server login first (sets HttpOnly cookie on success)
      try{
        const res = await fetch('/api/auth-login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username, password }) });
        if (res.ok){
          window.location.href = 'mmp_calendar_app.html';
          return;
        }
      }catch(e){ /* fall through to local */ }
      // Fallback to localStorage-based auth (matches admin/app behavior)
      await ensureAdminSeed();
      if (await localLogin(username, password)){
        window.location.href = 'mmp_calendar_app.html';
      } else {
        els.error.textContent = 'Invalid credentials';
        els.error.style.display = '';
      }
    }

    els.loginBtn.addEventListener('click', doLogin);
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') doLogin(); });

    // If already logged in via cookie or local session, redirect to app
    (async function(){
      loadUsers();
      await ensureAdminSeed();
      try{ const me = await fetch('/api/me'); if (me.ok){ window.location.href = 'mmp_calendar_app.html'; return; } }catch(e){}
      try{
        const savedUser = (localStorage.getItem(STORE_CURRENT_USER_KEY)||'').trim();
        const loginTime = parseInt(localStorage.getItem(STORE_LOGIN_TIME_KEY)||'0', 10) || 0;
        if (savedUser && users[savedUser] && loginTime && (Date.now() - loginTime) < SESSION_TTL_MS){
          window.location.href = 'mmp_calendar_app.html';
          return;
        }
      }catch(e){}
    })();
  </script>
</body>
</html>